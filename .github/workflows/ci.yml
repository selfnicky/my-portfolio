name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# Add permissions for better control
permissions:
  id-token: write
  contents: read
  packages: write

env:
  ECR_REPO: ${{ secrets.REGISTRY_USER }}
  IMAGE_TAG: ${{ github.run_number }}

# Define stages for better visualization
jobs:
  # ========================
  # STAGE 1: BUILD
  # ========================
  docker_build:
    name: "ğŸ—ï¸ Stage 1: Build Docker Image"
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ env.IMAGE_TAG }}
    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ”„ Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ğŸ³ Build Docker Image"
        run: |
          docker build -t ${{ secrets.REGISTRY_USER }}/portfolio:${{ env.IMAGE_TAG }} .
          docker tag ${{ secrets.REGISTRY_USER }}/portfolio:${{ env.IMAGE_TAG }} ${{ secrets.REGISTRY_USER }}/portfolio:latest
          
      - name: "ğŸ“ Save Image Metadata"
        run: |
          echo "Image built: ${{ secrets.REGISTRY_USER }}/portfolio:${{ env.IMAGE_TAG }}"
          echo "Run number: ${{ github.run_number }}"
          echo "Commit SHA: ${{ github.sha }}"

  # ========================
  # STAGE 2: SECURITY SCAN
  # ========================
  trivy_scan:
    name: "ğŸ”’ Stage 2: Security Scan"
    needs: docker_build
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ” Run Trivy Vulnerability Scanner"
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ secrets.REGISTRY_USER }}/portfolio:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: 0  # Don't fail the build, just report

      - name: "ğŸ“Š Upload Security Scan Results"
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-results.sarif

  # ========================
  # STAGE 3: PUSH TO REGISTRY
  # ========================
  push_image:
    name: "ğŸ“¦ Stage 3: Push to Registry"
    needs: trivy_scan
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ” Login to Container Registry"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASS }}

      - name: "ğŸš€ Push Docker Images"
        run: |
          docker push ${{ secrets.REGISTRY_USER }}/portfolio:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.REGISTRY_USER }}/portfolio:latest
          echo "âœ… Images pushed successfully!"

  # ========================
  # STAGE 4: DEPLOYMENTS
  # ========================
  
  # Parallel deployment strategies
  ssh_deploy:
    name: "ğŸš€ Stage 4a: SSH Deploy"
    needs: push_image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Only deploy from main
    steps:
      - name: "ğŸ”‘ SSH to Server"
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            echo "ğŸ“¦ Pulling image: ${{ secrets.REGISTRY_USER }}/portfolio:${{ env.IMAGE_TAG }}"
            
            # Stop and remove existing container
            docker rm -f resume || echo "No existing container to remove"
            
            # Pull new image
            docker pull ${{ secrets.REGISTRY_USER }}/portfolio:${{ env.IMAGE_TAG }}
            
            # Run new container
            docker run -d \
              --name resume \
              --restart unless-stopped \
              -p 8080:5001 \
              ${{ secrets.REGISTRY_USER }}/portfolio:${{ env.IMAGE_TAG }}
            
            echo "âœ… Deployment completed!"
            echo "ğŸŒ Application available at: http://$(hostname -I | awk '{print $1}'):8080"

  ecs_deploy:
    name: "â˜ï¸ Stage 4b: ECS Deploy"
    needs: push_image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Only deploy from main
    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ” Configure AWS Credentials (OIDC)"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: "ğŸ“‹ Render ECS Task Definition"
        id: taskdef
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ecs-taskdef.json
          container-name: dev
          image: ${{ env.ECR_REPO }}/portfolio:${{ env.IMAGE_TAG }}

      - name: "ğŸš€ Deploy to ECS"
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          cluster: nginx-fargate-cluster
          service: nginx-fargate-service
          task-definition: ${{ steps.taskdef.outputs.task-definition }}
          wait-for-service-stability: true
          force-new-deployment: true

  # ========================
  # FINAL: NOTIFICATIONS
  # ========================
  notification:
    name: "ğŸ“¢ Stage 5: Notifications"
    needs: [ssh_deploy, ecs_deploy]
    runs-on: ubuntu-latest
    if: always()  # Run even if previous jobs fail
    steps:
      - name: "ğŸ“Š Workflow Status"
        run: |
          echo "ğŸ‰ CI/CD Pipeline Completed!"
          echo "=============================="
          echo "Run Number: ${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo "Image: ${{ secrets.REGISTRY_USER }}/portfolio:${{ env.IMAGE_TAG }}"
          echo "Deployments:"
          echo "  - SSH: ${{ needs.ssh_deploy.result || 'N/A' }}"
          echo "  - ECS: ${{ needs.ecs_deploy.result || 'N/A' }}"
          
      - name: "ğŸ“¨ Send Slack Notification"
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          author_name: CI/CD Pipeline
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}